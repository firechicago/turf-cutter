<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-pip/v0.0.2/leaflet-pip.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>
<style>
body { margin:0; padding:0; }
#map { position:absolute; height: 95%; width:100%; }
</style>

<div id='map'></div>

<a href='#' id='geolocate' class='button right'>Center on my location</a>

<script>
L.mapbox.accessToken = 'pk.eyJ1IjoiY2hyaXN3YW5kIiwiYSI6Ii15YVZETmcifQ.iwFzK-RnFcNDU_msz06eQQ';
var map = L.mapbox.map('map', 'chriswand.kdm86mf3');

var votersLayer = L.mapbox.featureLayer().addTo(map)

votersLayer.on('layeradd', function(e) {
  var marker = e.layer,
  feature = marker.feature;

  // Create custom popup content
  var popupContent =  '<a target="_blank" class="popup" href="' + feature.properties.url + '">' +
  feature.properties.title + '<br>' + feature.properties.description +
  '</a>';

  // http://leafletjs.com/reference.html#popup
  marker.bindPopup(popupContent,{
    closeButton: false,
  });
});

var voters = <%= @geojson.html_safe %>

votersLayer.setGeoJSON(voters)

map.fitBounds(votersLayer.getBounds());

var geolocate = document.getElementById('geolocate');

if (!navigator.geolocation) {
  geolocate.innerHTML = 'Geolocation is not available';
} else {
  geolocate.onclick = function (e) {
    e.preventDefault();
    e.stopPropagation();
    map.locate();
  };
}

map.on('locationfound', function(e) {
  map.fitBounds(e.bounds);
});

map.on('locationerror', function() {
  geolocate.innerHTML = 'Position could not be found';
});

</script>
